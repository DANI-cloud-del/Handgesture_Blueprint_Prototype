<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Regions - Blueprint Converter</title>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', system-ui, sans-serif;
        background: #1a1a2e;
        overflow: hidden;
        height: 100vh;
    }

    .canvas-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 360px;
        height: 100vh;
        background: #0f0f1e;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    #blueprintCanvas {
        max-width: 100%;
        max-height: 100%;
        cursor: crosshair;
        object-fit: contain;
    }

    .controls-panel {
        position: fixed;
        top: 0;
        right: 0;
        width: 340px;
        height: 100vh;
        background: rgba(255, 255, 255, 0.98);
        padding: 25px;
        box-shadow: -5px 0 30px rgba(0,0,0,0.3);
        z-index: 1000;
        overflow-y: auto;
        border-left: 3px solid #667eea;
    }

    .controls-panel h2 {
        font-size: 20px;
        margin-bottom: 20px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .instructions {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        font-size: 13px;
        border-left: 3px solid #667eea;
    }

    .instructions strong {
        color: #333;
        display: block;
        margin-bottom: 8px;
    }

    .instructions ul {
        margin-left: 18px;
        margin-top: 8px;
    }

    .instructions li {
        margin: 5px 0;
        color: #555;
    }

    .stats {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 14px;
        color: #1976d2;
        text-align: center;
        border: 2px solid #90caf9;
    }

    .stats strong {
        font-size: 24px;
        display: block;
        margin-top: 5px;
        color: #667eea;
    }

    button {
        width: 100%;
        padding: 14px;
        margin: 8px 0;
        font-size: 15px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        opacity: 0.6;
    }

    .btn-secondary {
        background: #f0f0f0;
        color: #333;
    }

    .btn-secondary:hover {
        background: #e0e0e0;
        transform: translateY(-1px);
    }

    .btn-danger {
        background: linear-gradient(135deg, #ff5252 0%, #f50057 100%);
        color: white;
    }

    .btn-danger:hover {
        background: linear-gradient(135deg, #ff1744 0%, #c51162 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(255, 82, 82, 0.5);
    }

    #status {
        margin-top: 15px;
        padding: 12px;
        border-radius: 10px;
        display: none;
        font-size: 13px;
        font-weight: 500;
    }

    #status.show {
        display: block;
    }

    #status.success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
    }

    #status.error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-overlay.show {
        display: flex;
    }

    .spinner {
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top: 5px solid #667eea;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        color: white;
        margin-top: 20px;
        font-size: 18px;
        font-weight: 500;
    }

    @media (max-width: 1024px) {
        .canvas-container {
            right: 0;
            bottom: 200px;
        }
        
        .controls-panel {
            top: auto;
            bottom: 0;
            width: 100%;
            height: 200px;
            border-left: none;
            border-top: 3px solid #667eea;
        }
    }

    .controls-panel::-webkit-scrollbar {
        width: 6px;
    }

    .controls-panel::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .controls-panel::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 3px;
    }

    .controls-panel::-webkit-scrollbar-thumb:hover {
        background: #5568d3;
    }
</style>
</head>
<body>
    <div class="canvas-container" id="canvasContainer">
        <canvas id="blueprintCanvas"></canvas>
    </div>

    <div class="controls-panel">
        <h2>üîß Region Selector</h2>
        
        <div class="instructions">
            <strong>Instructions:</strong>
            <ul>
                <li>Click & drag to select areas</li>
                <li>Select structural elements only</li>
                <li>Avoid furniture areas</li>
            </ul>
        </div>

        <div class="stats" id="statsDisplay">
            Regions selected: <strong id="regionCount">0</strong>
        </div>

        <button class="btn-primary" id="generateBtn" onclick="generateModel()" disabled>
            Generate 3D Model
        </button>
        <button class="btn-danger" onclick="clearSelections()">
            Clear Selections
        </button>
        <button class="btn-secondary" onclick="goBack()">
            ‚Üê Back to Upload
        </button>
        <button class="btn-primary" onclick="generateFromML()" style="margin-top: 10px;">
            ü§ñ Generate 3D from ML Detections
        </button>

        <div id="status"></div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <div class="loading-text">Processing regions...</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('blueprintCanvas');
        const ctx = canvas.getContext('2d');
        let blueprintImage = new Image();
        let selections = [];
        let isDrawing = false;
        let startX, startY;
        let currentSelection = null;
        let imageScale = 1;
        let imageOffsetX = 0;
        let imageOffsetY = 0;

        const pngFilename = "{{ png_filename }}";
        
        console.log('PNG filename from backend:', pngFilename);
        
        if (!pngFilename || pngFilename === '') {
            document.getElementById('status').className = 'error show';
            document.getElementById('status').textContent = 'Error: No blueprint image found';
        } else {
            console.log('Loading blueprint:', pngFilename);
            
            blueprintImage.onload = function() {
                console.log('‚úì Image loaded:', blueprintImage.width, 'x', blueprintImage.height);
                
                const availableWidth = window.innerWidth - 360;
                const availableHeight = window.innerHeight;
                const imageAspect = blueprintImage.width / blueprintImage.height;
                const availableAspect = availableWidth / availableHeight;
                
                if (imageAspect > availableAspect) {
                    canvas.width = availableWidth * 0.95;
                    canvas.height = canvas.width / imageAspect;
                } else {
                    canvas.height = availableHeight * 0.95;
                    canvas.width = canvas.height * imageAspect;
                }
                
                imageScale = canvas.width / blueprintImage.width;
                redraw();
            };
            
            blueprintImage.onerror = function() {
                console.error('Failed to load image from:', `/static/blueprints/${pngFilename}`);
                document.getElementById('status').className = 'error show';
                document.getElementById('status').textContent = 'Error: Failed to load blueprint image';
            };
            
            blueprintImage.src = `/static/blueprints/${pngFilename}`;
            console.log('Image src set to:', blueprintImage.src);
        }

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            isDrawing = true;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            currentSelection = {
                x: Math.min(startX, currentX),
                y: Math.min(startY, currentY),
                width: Math.abs(currentX - startX),
                height: Math.abs(currentY - startY)
            };
            
            redraw();
        });

        canvas.addEventListener('mouseup', (e) => {
            if (isDrawing && currentSelection && currentSelection.width > 5 && currentSelection.height > 5) {
                selections.push({
                    x: currentSelection.x / canvas.width,
                    y: currentSelection.y / canvas.height,
                    width: currentSelection.width / canvas.width,
                    height: currentSelection.height / canvas.height
                });
                
                updateStats();
                currentSelection = null;
                isDrawing = false;
                redraw();
            } else {
                currentSelection = null;
                isDrawing = false;
            }
        });

        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(blueprintImage, 0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = '#667eea';
            ctx.fillStyle = 'rgba(102, 126, 234, 0.25)';
            ctx.lineWidth = 3;
            
            selections.forEach((sel, idx) => {
                const x = sel.x * canvas.width;
                const y = sel.y * canvas.height;
                const w = sel.width * canvas.width;
                const h = sel.height * canvas.height;
                
                ctx.fillRect(x, y, w, h);
                ctx.strokeRect(x, y, w, h);
                
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 20px Arial';
                ctx.fillText(`#${idx + 1}`, x + 10, y + 30);
                ctx.fillStyle = 'rgba(102, 126, 234, 0.25)';
            });
            
            if (currentSelection) {
                ctx.fillRect(currentSelection.x, currentSelection.y, 
                           currentSelection.width, currentSelection.height);
                ctx.strokeRect(currentSelection.x, currentSelection.y, 
                             currentSelection.width, currentSelection.height);
            }
        }

        function updateStats() {
            document.getElementById('regionCount').textContent = selections.length;
            document.getElementById('generateBtn').disabled = selections.length === 0;
        }

        function clearSelections() {
            selections = [];
            updateStats();
            redraw();
            
            // Clear analysis if shown
            const analysisDiv = document.getElementById('analysis-results');
            if (analysisDiv) {
                analysisDiv.remove();
            }
        }

        function generateModel() {
            const statusDiv = document.getElementById('status');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            if (selections.length === 0) {
                statusDiv.className = 'error show';
                statusDiv.textContent = 'Please select at least one region';
                return;
            }
            
            loadingOverlay.classList.add('show');
            
            fetch('/process-regions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ regions: selections })
            })
            .then(response => response.json())
            .then(data => {
                loadingOverlay.classList.remove('show');
                
                if (data.error) {
                    statusDiv.className = 'error show';
                    statusDiv.textContent = 'Error: ' + data.error;
                } else {
                    localStorage.setItem('meshData', JSON.stringify(data.mesh_data));
                    window.location.href = data.redirect;
                }
            })
            .catch(error => {
                loadingOverlay.classList.remove('show');
                statusDiv.className = 'error show';
                statusDiv.textContent = 'Processing failed: ' + error.message;
            });
        }

        function goBack() {
            window.location.href = '/';
        }

        window.addEventListener('resize', () => {
            if (blueprintImage.complete) {
                const availableWidth = window.innerWidth - 360;
                const availableHeight = window.innerHeight;
                const imageAspect = blueprintImage.width / blueprintImage.height;
                const availableAspect = availableWidth / availableHeight;
                
                if (imageAspect > availableAspect) {
                    canvas.width = availableWidth * 0.95;
                    canvas.height = canvas.width / imageAspect;
                } else {
                    canvas.height = availableHeight * 0.95;
                    canvas.width = canvas.height * imageAspect;
                }
                
                imageScale = canvas.width / blueprintImage.width;
                redraw();
            }
        });
    </script>

    <script>
        // ANALYZE REGION FUNCTIONALITY
        function analyzeSelectedRegion() {
            if (selections.length === 0) {
                alert('Please select a region first');
                return;
            }
            
            const region = selections[selections.length - 1];
            
            fetch('/analyze-region', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({region: region})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    displayRegionAnalysis(data.analysis);
                } else {
                    alert('Analysis failed: ' + data.error);
                }
            })
            .catch(err => {
                console.error('Analysis error:', err);
                alert('Analysis failed');
            });
        }

        function displayRegionAnalysis(analysis) {
            let html = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìä Region Analysis</h3>
                    <div style="background: #f0f4ff; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <strong style="font-size: 18px; color: #667eea;">Total: ${analysis.total}</strong>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #333; border-bottom: 2px solid #667eea; padding-bottom: 5px;">üèóÔ∏è Structural</h4>
                        <ul style="list-style: none; padding-left: 0; margin-top: 10px;">
                            <li style="padding: 5px 0;">üß± Walls: <strong>${analysis.walls}</strong></li>
                            <li style="padding: 5px 0;">üö™ Doors: <strong>${analysis.doors}</strong></li>
                            <li style="padding: 5px 0;">ü™ü Windows: <strong>${analysis.windows}</strong></li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #333; border-bottom: 2px solid #667eea; padding-bottom: 5px;">ü™ë Furniture</h4>
                        <ul style="list-style: none; padding-left: 0; margin-top: 10px;">
                            <li style="padding: 5px 0;">üìä Tables: <strong>${analysis.tables}</strong></li>
                            <li style="padding: 5px 0;">üí∫ Chairs: <strong>${analysis.chairs}</strong></li>
                            <li style="padding: 5px 0;">üõèÔ∏è Beds: <strong>${analysis.beds}</strong></li>
                            <li style="padding: 5px 0;">üõãÔ∏è Sofas: <strong>${analysis.sofas}</strong></li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 style="color: #333; border-bottom: 2px solid #667eea; padding-bottom: 5px;">üöΩ Facilities</h4>
                        <ul style="list-style: none; padding-left: 0; margin-top: 10px;">
                            <li style="padding: 5px 0;">üöΩ Toilets: <strong>${analysis.toilets}</strong></li>
                            <li style="padding: 5px 0;">üö∞ Sinks: <strong>${analysis.sinks}</strong></li>
                            <li style="padding: 5px 0;">üõÅ Bathtubs: <strong>${analysis.bathtubs}</strong></li>
                            <li style="padding: 5px 0;">ü™ú Stairs: <strong>${analysis.stairs}</strong></li>
                            <li style="padding: 5px 0;">üõó Elevators: <strong>${analysis.elevators}</strong></li>
                            <li style="padding: 5px 0;">üÖøÔ∏è Parking: <strong>${analysis.parking}</strong></li>
                        </ul>
                    </div>
                </div>
            `;
            
            const panel = document.querySelector('.controls-panel');
            let resultDiv = document.getElementById('analysis-results');
            
            if (!resultDiv) {
                resultDiv = document.createElement('div');
                resultDiv.id = 'analysis-results';
                panel.appendChild(resultDiv);
            }
            
            resultDiv.innerHTML = html;
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function generateFromML() {
            const statusDiv = document.getElementById('status');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            loadingOverlay.classList.add('show');
            
            fetch('/generate-from-ml', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                loadingOverlay.classList.remove('show');
                
                if (data.error) {
                    statusDiv.className = 'error show';
                    statusDiv.textContent = 'Error: ' + data.error;
                } else {
                    localStorage.setItem('meshData', JSON.stringify(data.mesh_data));
                    window.location.href = data.redirect;
                }
            })
            .catch(error => {
                loadingOverlay.classList.remove('show');
                statusDiv.className = 'error show';
                statusDiv.textContent = 'Generation failed: ' + error.message;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const controlsPanel = document.querySelector('.controls-panel');
            
            const analyzeBtn = document.createElement('button');
            analyzeBtn.textContent = 'üìä Analyze Selected Region';
            analyzeBtn.className = 'btn-primary';
            analyzeBtn.id = 'analyzeBtn';
            analyzeBtn.onclick = analyzeSelectedRegion;
            analyzeBtn.disabled = true;
            analyzeBtn.style.marginTop = '10px';
            
            const clearBtn = controlsPanel.querySelector('.btn-danger');
            clearBtn.parentNode.insertBefore(analyzeBtn, clearBtn.nextSibling);
            
            const originalUpdateStats = window.updateStats;
            window.updateStats = function() {
                originalUpdateStats();
                const analyzeButton = document.getElementById('analyzeBtn');
                if (analyzeButton) {
                    analyzeButton.disabled = selections.length === 0;
                }
            };
        });
    </script>
</body>
</html>
